# Two-panel plot (map + boxplot) of viceroy non-volatiles
# Jeffrey C. Oliver
# jcoliver@email.arizona.edu
# 2017-03-07

rm(list = ls())

################################################################################
# SUMMARY
# Creates two plots, a map on the left and a boxplot on the right

################################################################################
# SPECIFICS
# Add information unique to this set of figures
data.file <- "data/abundance-data.txt"
output.file <- "output/Abundance-map-only"
vars <- data.frame(var.name <- c("Number.Viceroy.Adults", 
                                 "Number.Carolina.Willow.Plants", 
                                 "Number.Queen.Adults", 
                                 "Number.Twinevine.Plants"),
                   var.text <- c("Viceroys (# inds.)", 
                                 "Willows (# inds.)", 
                                 "Queens (# inds.)", 
                                 "Twinevines (# inds.)"),
                   stringsAsFactors = FALSE)
separate.files <- TRUE

################################################################################
# SHOULD NOT NEED TO EDIT ANYTHING BELOW HERE
################################################################################

################################################################################
# PLOT
source(file = "functions/mapping-functions.R")
# If plotting to separate files:
#   Loop over each variable
#   Call MakeFloridaMap
# If all plots going to a single file:
#   Load source files
#   Read in data
#   Prepare data
#   Set file format
#   Setup multi-panel plot dimensions
#   Loop over each variable to plot
#     Draw map

plot.data <- read.table(file = data.file, header = TRUE, sep = "\t")

if (separate.files) {
  

  for (variable in 1:nrow(vars)) {
    outfile <- paste0(output.file, "-", vars$var.name[variable])

    
    MakeFloridaMap(plot.data = plot.data,
                   variable.name = variable.name,
                   variable.text = variable.text,
                   map.shade.colors = plotting.globals$map.colors,
                   map.point.outline = plotting.globals$map.point.outline,
                   map.point.cex = plotting.globals$map.point.cex,
                   groups = plotting.globals$groups,
                   group.cols = plotting.globals$group.cols)
    
    TwoPanelPlot(datafile = data.file,
                 outputfile = outfile,
                 varname = vars$var.name[variable],
                 vartext = vars$var.text[variable])
    # MapWithInsetBoxplot(datafile = data.file,
    #                     outputfile = outfile,
    #                     varname = vars$var.name[variable],
    #                     vartext = vars$var.text[variable])
  }
  
} else {
  # Load dependancies
  source(file = "plotting-globals.R")
  
  # Read data with latitude, longitude, and whatever variable(s) to graph
  plot.data <- read.delim(file = data.file)
  
  # Prep output file name
  file.format <- plotting.globals$output.format
  output.file <- paste0(output.file, ".", file.format)
  
  # Set file format
  if (file.format == "pdf") {
    pdf(file = output.file, useDingbats = FALSE)
  } else if (file.format == "png") {
    png(filename = output.file, width = 1200, height = 1200, units = "px", res = 150)
  }
  
  # Setup multi-panel plot dimensions
  par(mfrow = c(nrow(vars), 2))
  
  # Loop over each variable to plot
  for (variable in 1:nrow(vars)) {
    variable.name <- vars$var.name[variable]
    variable.text <- vars$var.text[variable]
    
    # Map
    par(mar = c(0, 0, 0, 0))
    
    MakeFloridaMap(plot.data = plot.data,
                   variable.name = variable.name,
                   variable.text = variable.text,
                   map.shade.colors = plotting.globals$map.colors,
                   map.point.outline = plotting.globals$map.point.outline,
                   map.point.cex = plotting.globals$map.point.cex,
                   groups = plotting.globals$groups,
                   group.cols = plotting.globals$group.cols)
    
    # Boxplot
    par(mar = c(1.5, 3, 1, 1))
    
    group.by <- "Site.Name"
    
    MakeBoxplot(plot.data = plot.data,
                variable.name = variable.name,
                variable.text = variable.text,
                grouping.var = group.by,
                col.middle.bar = plotting.globals$group.alt.cols,
                col.boxes = plotting.globals$group.cols,
                xlabs = factor(x = names(plotting.globals$groups)),
                groups = plotting.globals$groups)
    
  }
  
  # Reset graphical parameters to default values
  par(mfrow = c(1, 1), mar = c(5, 4, 4, 2) + 0.1)
  
  # Close pipe to graphics device
  dev.off()
}
